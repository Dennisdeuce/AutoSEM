<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoSEM ‚Äî Court Sportswear Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #05080f;
  --surface: #0d1117;
  --surface2: #161b22;
  --border: #21262d;
  --text: #e6edf3;
  --dim: #7d8590;
  --green: #3fb950;
  --green-bg: rgba(63,185,80,0.1);
  --red: #f85149;
  --red-bg: rgba(248,81,73,0.1);
  --amber: #d29922;
  --amber-bg: rgba(210,153,34,0.1);
  --blue: #58a6ff;
  --blue-bg: rgba(88,166,255,0.1);
  --purple: #bc8cff;
  --purple-bg: rgba(188,140,255,0.1);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'Space Grotesk',sans-serif; line-height:1.6; }
.wrap { max-width:1200px; margin:0 auto; padding:24px; }

/* Header */
.hdr { display:flex; justify-content:space-between; align-items:center; padding-bottom:20px; border-bottom:1px solid var(--border); margin-bottom:24px; flex-wrap:wrap; gap:12px; }
.hdr h1 { font-size:22px; font-weight:700; letter-spacing:-0.5px; }
.hdr h1 span { color:var(--blue); }
.hdr-right { display:flex; align-items:center; gap:16px; }
.hdr-pill { font-family:'IBM Plex Mono'; font-size:11px; padding:4px 12px; border-radius:20px; display:flex; align-items:center; gap:6px; }
.hdr-pill.live { background:var(--green-bg); color:var(--green); }
.hdr-pill.ver { background:var(--blue-bg); color:var(--blue); }
.hdr-pill .dot { width:6px; height:6px; border-radius:50%; background:var(--green); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
#lastUpdate { font-family:'IBM Plex Mono'; font-size:11px; color:var(--dim); }

/* Tabs */
.tabs { display:flex; gap:4px; margin-bottom:24px; border-bottom:1px solid var(--border); padding-bottom:0; }
.tab { padding:10px 20px; font-size:13px; font-weight:600; color:var(--dim); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; }
.tab:hover { color:var(--text); }
.tab.active { color:var(--blue); border-bottom-color:var(--blue); }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* Cards */
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; margin-bottom:20px; }
.card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; }
.card .lbl { font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--dim); margin-bottom:6px; }
.card .val { font-family:'IBM Plex Mono'; font-size:26px; font-weight:700; letter-spacing:-0.5px; }
.card .note { font-size:11px; color:var(--dim); margin-top:4px; }
.g { color:var(--green); } .r { color:var(--red); } .a { color:var(--amber); } .b { color:var(--blue); }

/* Table */
.tbl { width:100%; border-collapse:collapse; font-size:13px; background:var(--surface); border-radius:12px; overflow:hidden; margin-bottom:20px; }
.tbl th { text-align:left; padding:10px 14px; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--dim); border-bottom:1px solid var(--border); font-weight:500; }
.tbl td { padding:10px 14px; border-bottom:1px solid var(--border); }
.tbl tr:last-child td { border-bottom:none; }
.mono { font-family:'IBM Plex Mono'; font-weight:500; }

/* Insight */
.ins { background:var(--surface); border-left:3px solid var(--blue); border-radius:0 12px 12px 0; padding:14px 18px; margin-bottom:14px; font-size:14px; line-height:1.7; }
.ins.warn { border-left-color:var(--amber); }
.ins.crit { border-left-color:var(--red); }
.ins.good { border-left-color:var(--green); }

/* Progress */
.prog { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
.prog-lbl { width:130px; flex-shrink:0; font-size:13px; color:var(--dim); text-align:right; }
.prog-track { flex:1; height:22px; background:var(--surface2); border-radius:6px; overflow:hidden; }
.prog-fill { height:100%; border-radius:6px; display:flex; align-items:center; padding:0 10px; font-family:'IBM Plex Mono'; font-size:11px; font-weight:500; transition:width 0.8s ease; }

/* Check items */
.chk { display:flex; align-items:flex-start; gap:10px; padding:10px 14px; border-bottom:1px solid var(--border); font-size:13px; }
.chk:last-child { border-bottom:none; }
.chk .ic { font-size:14px; flex-shrink:0; }

/* Loading */
.loading { text-align:center; padding:40px; color:var(--dim); }
.loading::after { content:''; display:inline-block; width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--blue); border-radius:50%; animation:spin 0.8s linear infinite; margin-left:8px; vertical-align:middle; }
@keyframes spin { to{transform:rotate(360deg)} }

/* Error */
.err-banner { background:var(--red-bg); border:1px solid rgba(248,81,73,0.3); border-radius:10px; padding:12px 16px; margin-bottom:16px; font-size:13px; color:var(--red); display:none; }

@media(max-width:700px) { .grid{grid-template-columns:1fr 1fr;} .tabs{overflow-x:auto;} }
</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<div class="hdr">
  <h1>Auto<span>SEM</span> ‚Äî Court Sportswear</h1>
  <div class="hdr-right">
    <div class="hdr-pill live"><span class="dot"></span> <span id="healthStatus">Connecting...</span></div>
    <div class="hdr-pill ver" id="versionPill">v--</div>
    <span id="lastSync" style="font-family:'IBM Plex Mono';font-size:11px;color:var(--dim)">Last sync: ‚Äî</span>
    <span id="lastUpdate">‚Äî</span>
  </div>
</div>

<div class="err-banner" id="errBanner"></div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" data-tab="overview">Overview</div>
  <div class="tab" data-tab="meta">Meta Ads</div>
  <div class="tab" data-tab="klaviyo">Klaviyo</div>
  <div class="tab" data-tab="shopify">Shopify</div>
  <div class="tab" data-tab="seo">SEO & Content</div>
  <div class="tab" data-tab="system">System Health</div>
  <div class="tab" data-tab="tasks">Task Tracker</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERVIEW TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel active" id="panel-overview">
  <div class="grid" id="overviewCards">
    <div class="card"><div class="lbl">Meta Spend (7d)</div><div class="val b" id="ov-spend">‚Äî</div><div class="note" id="ov-spend-note"></div></div>
    <div class="card"><div class="lbl">Total Revenue</div><div class="val g" id="ov-revenue">‚Äî</div><div class="note" id="ov-revenue-note">From attributed orders</div></div>
    <div class="card"><div class="lbl">Meta Clicks</div><div class="val g" id="ov-clicks">‚Äî</div><div class="note" id="ov-clicks-note"></div></div>
    <div class="card"><div class="lbl">Avg CPC</div><div class="val g" id="ov-cpc">‚Äî</div><div class="note" id="ov-cpc-note"></div></div>
  </div>
  <div class="grid">
    <div class="card"><div class="lbl">Products</div><div class="val" id="ov-products">‚Äî</div><div class="note" id="ov-products-note"></div></div>
    <div class="card"><div class="lbl">Collections</div><div class="val" id="ov-collections">‚Äî</div><div class="note" id="ov-collections-note"></div></div>
    <div class="card"><div class="lbl">Blog Posts</div><div class="val b" id="ov-blogs">‚Äî</div><div class="note">SEO content</div></div>
    <div class="card"><div class="lbl">Shopify Token</div><div class="val" id="ov-token">‚Äî</div><div class="note" id="ov-token-note"></div></div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin:20px 0 12px">
    <span style="font-size:15px;font-weight:600;color:var(--dim)">Last Optimizer Actions</span>
    <div style="display:flex;gap:8px">
      <button onclick="runSyncPerformance()" style="background:var(--blue-bg);color:var(--blue);border:1px solid rgba(88,166,255,0.3);padding:6px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">‚Üª Sync Performance</button>
      <button onclick="runOptimizeNow()" style="background:var(--green-bg);color:var(--green);border:1px solid rgba(63,185,80,0.3);padding:6px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">‚ñ∂ Optimize Now</button>
    </div>
  </div>
  <div id="optimizerStatus" style="font-size:12px;color:var(--dim);margin-bottom:8px"></div>
  <table class="tbl">
    <thead><tr><th>Time</th><th>Action</th><th>Campaign</th><th>Details</th></tr></thead>
    <tbody id="optimizerRows"><tr><td colspan="4" class="loading">Loading optimizer actions</td></tr></tbody>
  </table>

  <!-- Revenue Pipeline Funnel -->
  <div style="font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--dim)">Revenue Pipeline</div>
  <div id="funnelSection" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:20px">
    <div id="funnelLoading" class="loading">Loading funnel data</div>
    <div id="funnelContent" style="display:none">
      <div style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;margin-bottom:14px">
        <div style="flex:1;min-width:120px;text-align:center;padding:12px;background:var(--surface2);border-radius:10px">
          <div style="font-size:11px;color:var(--dim);text-transform:uppercase;margin-bottom:4px">Impressions</div>
          <div style="font-family:'IBM Plex Mono';font-size:22px;font-weight:700;color:var(--blue)" id="fn-impressions">‚Äî</div>
        </div>
        <div style="display:flex;align-items:center;color:var(--dim);font-size:18px">‚Üí</div>
        <div style="flex:1;min-width:120px;text-align:center;padding:12px;background:var(--surface2);border-radius:10px">
          <div style="font-size:11px;color:var(--dim);text-transform:uppercase;margin-bottom:4px">Clicks</div>
          <div style="font-family:'IBM Plex Mono';font-size:22px;font-weight:700;color:var(--green)" id="fn-clicks">‚Äî</div>
          <div style="font-size:10px;color:var(--dim)" id="fn-ctr">‚Äî</div>
        </div>
        <div style="display:flex;align-items:center;color:var(--dim);font-size:18px">‚Üí</div>
        <div style="flex:1;min-width:120px;text-align:center;padding:12px;background:var(--surface2);border-radius:10px">
          <div style="font-size:11px;color:var(--dim);text-transform:uppercase;margin-bottom:4px">Page Views</div>
          <div style="font-family:'IBM Plex Mono';font-size:22px;font-weight:700" id="fn-lpv">‚Äî</div>
          <div style="font-size:10px;color:var(--dim)" id="fn-lpv-rate">‚Äî</div>
        </div>
        <div style="display:flex;align-items:center;color:var(--dim);font-size:18px">‚Üí</div>
        <div style="flex:1;min-width:120px;text-align:center;padding:12px;background:var(--surface2);border-radius:10px">
          <div style="font-size:11px;color:var(--dim);text-transform:uppercase;margin-bottom:4px">Purchases</div>
          <div style="font-family:'IBM Plex Mono';font-size:22px;font-weight:700" id="fn-purchases">‚Äî</div>
          <div style="font-size:10px;color:var(--dim)" id="fn-conv-rate">‚Äî</div>
        </div>
        <div style="display:flex;align-items:center;color:var(--dim);font-size:18px">‚Üí</div>
        <div style="flex:1;min-width:120px;text-align:center;padding:12px;background:var(--surface2);border-radius:10px">
          <div style="font-size:11px;color:var(--dim);text-transform:uppercase;margin-bottom:4px">Revenue</div>
          <div style="font-family:'IBM Plex Mono';font-size:22px;font-weight:700;color:var(--green)" id="fn-revenue">‚Äî</div>
        </div>
      </div>
      <div id="funnelWarning" style="display:none;background:var(--amber-bg);border:1px solid rgba(210,153,34,0.3);border-radius:10px;padding:14px 18px">
        <div style="font-weight:600;color:var(--amber);margin-bottom:8px" id="funnelWarningMsg"></div>
        <ul id="funnelChecklist" style="margin:0;padding-left:20px;font-size:13px;color:var(--text);line-height:2"></ul>
      </div>
    </div>
  </div>

  <div style="font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--dim)">Optimization Progress</div>
  <div id="overviewProgress">
    <div class="prog"><div class="prog-lbl">Overall</div><div class="prog-track"><div class="prog-fill" id="prog-overall" style="width:0%;background:rgba(63,185,80,0.6)"></div></div></div>
    <div class="prog"><div class="prog-lbl">Product SEO</div><div class="prog-track"><div class="prog-fill" id="prog-products" style="width:0%;background:rgba(63,185,80,0.6)"></div></div></div>
    <div class="prog"><div class="prog-lbl">Meta Ads</div><div class="prog-track"><div class="prog-fill" id="prog-meta" style="width:0%;background:rgba(63,185,80,0.6)"></div></div></div>
    <div class="prog"><div class="prog-lbl">Email Marketing</div><div class="prog-track"><div class="prog-fill" id="prog-email" style="width:0%;background:rgba(210,153,34,0.5)"></div></div></div>
    <div class="prog"><div class="prog-lbl">Technical SEO</div><div class="prog-track"><div class="prog-fill" id="prog-tech" style="width:0%;background:rgba(88,166,255,0.5)"></div></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê META ADS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-meta">
  <div class="grid" id="metaCards">
    <div class="card"><div class="lbl">Total Spend</div><div class="val b" id="m-spend">‚Äî</div></div>
    <div class="card"><div class="lbl">Total Revenue</div><div class="val g" id="m-revenue">‚Äî</div><div class="note" id="m-revenue-note"></div></div>
    <div class="card"><div class="lbl">ROAS</div><div class="val" id="m-roas">‚Äî</div><div class="note" id="m-roas-note"></div></div>
    <div class="card"><div class="lbl">Impressions</div><div class="val" id="m-impressions">‚Äî</div></div>
    <div class="card"><div class="lbl">Clicks</div><div class="val g" id="m-clicks">‚Äî</div></div>
    <div class="card"><div class="lbl">Avg CPC</div><div class="val g" id="m-cpc">‚Äî</div></div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <span style="font-size:15px;font-weight:600;color:var(--dim)">Campaigns</span>
    <button onclick="syncMeta()" style="background:var(--blue-bg);color:var(--blue);border:1px solid rgba(88,166,255,0.3);padding:6px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">‚Üª Sync Now</button>
  </div>
  <table class="tbl" id="metaTable">
    <thead><tr><th>Campaign</th><th>Status</th><th>Spend</th><th>Revenue</th><th>Clicks</th><th>CTR</th><th>CPC</th><th>ROAS</th><th>Signal</th></tr></thead>
    <tbody id="metaRows"><tr><td colspan="9" class="loading">Loading Meta data</td></tr></tbody>
  </table>
  <div class="ins" id="metaInsight" style="display:none"></div>

  <div style="font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--dim)">Campaign Controls</div>
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
    <input type="text" id="metaCampaignId" placeholder="Campaign ID" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px 12px;font-family:inherit;font-size:13px;width:220px">
    <button onclick="metaCampaignAction('activate')" style="background:var(--green-bg);color:var(--green);border:1px solid rgba(63,185,80,0.3);padding:8px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">Activate</button>
    <button onclick="metaCampaignAction('pause')" style="background:var(--amber-bg);color:var(--amber);border:1px solid rgba(210,153,34,0.3);padding:8px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">Pause</button>
    <input type="number" id="metaBudget" placeholder="Budget ($)" min="1" step="1" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px 12px;font-family:inherit;font-size:13px;width:120px">
    <button onclick="metaSetBudget()" style="background:var(--blue-bg);color:var(--blue);border:1px solid rgba(88,166,255,0.3);padding:8px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">Set Budget</button>
    <span id="metaActionResult" style="font-size:12px;color:var(--dim)"></span>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHOPIFY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-shopify">
  <div class="grid" id="shopifyCards">
    <div class="card"><div class="lbl">Store Status</div><div class="val" id="sh-status">‚Äî</div><div class="note" id="sh-store"></div></div>
    <div class="card"><div class="lbl">Active Products</div><div class="val" id="sh-products">‚Äî</div><div class="note" id="sh-products-note"></div></div>
    <div class="card"><div class="lbl">Collections</div><div class="val" id="sh-collections">‚Äî</div><div class="note" id="sh-collections-note"></div></div>
    <div class="card"><div class="lbl">Token Expires</div><div class="val" id="sh-token">‚Äî</div><div class="note" id="sh-token-note">Auto-refresh enabled</div></div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <span style="font-size:15px;font-weight:600;color:var(--dim)">Products</span>
    <button onclick="refreshToken()" style="background:var(--purple-bg);color:var(--purple);border:1px solid rgba(188,140,255,0.3);padding:6px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">‚Üª Refresh Token</button>
  </div>
  <table class="tbl">
    <thead><tr><th>Product</th><th>Price</th><th>Description</th><th>SEO</th></tr></thead>
    <tbody id="shopifyRows"><tr><td colspan="4" class="loading">Loading Shopify data</td></tr></tbody>
  </table>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEO TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-seo">
  <div class="grid">
    <div class="card"><div class="lbl">CRO Descriptions</div><div class="val g" id="seo-cro">‚Äî</div><div class="note">Target: 400+ chars</div></div>
    <div class="card"><div class="lbl">SEO Meta Tags</div><div class="val g" id="seo-meta">‚Äî</div><div class="note">Title + description</div></div>
    <div class="card"><div class="lbl">Blog Posts</div><div class="val b" id="seo-blogs">‚Äî</div><div class="note">Organic traffic drivers</div></div>
    <div class="card"><div class="lbl">Image Alt Tags</div><div class="val g" id="seo-alt">‚úì</div><div class="note">All images have alt text</div></div>
  </div>

  <div style="font-size:15px;font-weight:600;margin:8px 0 12px;color:var(--dim)">Blog Posts</div>
  <table class="tbl">
    <thead><tr><th>Title</th><th>Published</th><th>Tags</th></tr></thead>
    <tbody id="blogRows"><tr><td colspan="3" class="loading">Loading blog data</td></tr></tbody>
  </table>

  <div style="font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--dim)">Structured Data & Sitemap</div>
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:20px">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
      <a href="/api/v1/seo/sitemap.xml" target="_blank" style="background:var(--blue-bg);color:var(--blue);border:1px solid rgba(88,166,255,0.3);padding:6px 14px;border-radius:8px;font-size:12px;font-family:inherit;text-decoration:none;cursor:pointer">View Sitemap.xml</a>
      <button onclick="generateAllJsonLd()" style="background:var(--green-bg);color:var(--green);border:1px solid rgba(63,185,80,0.3);padding:6px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">Generate All JSON-LD</button>
      <span id="jsonldResult" style="font-size:12px;color:var(--dim)"></span>
    </div>
    <div id="jsonldStatus" style="font-size:13px;color:var(--dim)">Click "Generate All JSON-LD" to check product structured data coverage.</div>
  </div>

  <div style="font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--dim)">Technical SEO Status</div>
  <div style="background:var(--surface);border-radius:12px;overflow:hidden" id="techSeoChecks">
    <div class="chk"><span class="ic">‚úÖ</span> Sitemap.xml ‚Äî generated by AutoSEM SEO router</div>
    <div class="chk"><span class="ic">‚úÖ</span> Robots.txt ‚Äî properly configured</div>
    <div class="chk"><span class="ic">‚úÖ</span> Canonical URLs on all pages</div>
    <div class="chk"><span class="ic">‚úÖ</span> Open Graph tags (title, desc, image)</div>
    <div class="chk"><span class="ic">‚úÖ</span> Meta descriptions on all products</div>
    <div class="chk"><span class="ic">‚úÖ</span> SSL/HTTPS active</div>
    <div class="chk"><span class="ic">‚úÖ</span> Blog JSON-LD Article schema</div>
    <div class="chk" id="jsonld-check"><span class="ic">‚ö†Ô∏è</span> <strong>JSON-LD Product schema</strong> ‚Äî available via /api/v1/seo/all-jsonld, needs theme injection</div>
    <div class="chk"><span class="ic">‚ö†Ô∏è</span> <strong>Generic URL handles</strong> ‚Äî /products/mens-performance-crew-neck-tennis-t-shirt-5</div>
    <div class="chk"><span class="ic">‚ö†Ô∏è</span> <strong>Collection page 1.3MB</strong> ‚Äî 243 images, needs lazy loading</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KLAVIYO TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-klaviyo">
  <div class="grid" id="klaviyoCards">
    <div class="card"><div class="lbl">Connection</div><div class="val" id="kl-status">--</div><div class="note" id="kl-status-note"></div></div>
    <div class="card"><div class="lbl">Flows</div><div class="val b" id="kl-flows">--</div><div class="note">Active + draft</div></div>
    <div class="card"><div class="lbl">Email Metrics</div><div class="val g" id="kl-metrics">--</div><div class="note">Tracked events</div></div>
    <div class="card"><div class="lbl">Profiles</div><div class="val" id="kl-profiles">--</div><div class="note">Subscribers</div></div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <span style="font-size:15px;font-weight:600;color:var(--dim)">Flows</span>
    <button onclick="createAbandonedCartFlow()" style="background:var(--green-bg);color:var(--green);border:1px solid rgba(63,185,80,0.3);padding:6px 14px;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer">+ Create Abandoned Cart Flow</button>
  </div>
  <table class="tbl">
    <thead><tr><th>Flow Name</th><th>Status</th><th>Trigger</th><th>Updated</th></tr></thead>
    <tbody id="klaviyoFlowRows"><tr><td colspan="4" class="loading">Loading Klaviyo data</td></tr></tbody>
  </table>
  <div id="klaviyoFlowResult" style="display:none" class="ins good"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYSTEM HEALTH TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-system">
  <div class="grid" id="healthCards">
    <div class="card"><div class="lbl">Overall</div><div class="val g" id="h-overall">--</div></div>
    <div class="card"><div class="lbl">Database</div><div class="val" id="h-db">--</div></div>
    <div class="card"><div class="lbl">Scheduler</div><div class="val" id="h-scheduler">--</div></div>
    <div class="card"><div class="lbl">Issues</div><div class="val" id="h-issues">--</div></div>
  </div>

  <div style="font-size:15px;font-weight:600;margin:8px 0 12px;color:var(--dim)">Service Status</div>
  <div style="background:var(--surface);border-radius:12px;overflow:hidden" id="healthChecks">
    <div class="chk"><span class="ic" id="hc-db">--</span> <span id="hc-db-text">Database</span></div>
    <div class="chk"><span class="ic" id="hc-meta">--</span> <span id="hc-meta-text">Meta Token</span></div>
    <div class="chk"><span class="ic" id="hc-tiktok">--</span> <span id="hc-tiktok-text">TikTok Token</span></div>
    <div class="chk"><span class="ic" id="hc-shopify">--</span> <span id="hc-shopify-text">Shopify Token</span></div>
    <div class="chk"><span class="ic" id="hc-klaviyo">--</span> <span id="hc-klaviyo-text">Klaviyo</span></div>
    <div class="chk"><span class="ic" id="hc-sched">--</span> <span id="hc-sched-text">Scheduler</span></div>
    <div class="chk"><span class="ic" id="hc-opt">--</span> <span id="hc-opt-text">Last Optimization</span></div>
  </div>

  <div style="font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--dim)">Shopify Scopes</div>
  <div style="background:var(--surface);border-radius:12px;overflow:hidden;margin-bottom:20px;padding:14px 18px" id="shopifyScopesBox">
    <span style="color:var(--dim);font-size:13px">Loading scopes...</span>
  </div>

  <div style="font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--dim)">Recent Activity Log</div>
  <table class="tbl">
    <thead><tr><th>Time</th><th>Action</th><th>Details</th></tr></thead>
    <tbody id="activityLogRows"><tr><td colspan="3" class="loading">Loading activity log</td></tr></tbody>
  </table>

  <div style="font-size:15px;font-weight:600;margin:20px 0 12px;color:var(--dim)">Campaign & Financial Summary</div>
  <div class="grid">
    <div class="card"><div class="lbl">Total Campaigns</div><div class="val" id="h-campaigns">--</div><div class="note" id="h-campaigns-note"></div></div>
    <div class="card"><div class="lbl">Total Spend</div><div class="val r" id="h-spend">--</div></div>
    <div class="card"><div class="lbl">Total Revenue</div><div class="val g" id="h-revenue">--</div></div>
    <div class="card"><div class="lbl">Overall ROAS</div><div class="val b" id="h-roas">--</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TASKS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-tasks">
  <div style="font-size:15px;font-weight:600;margin-bottom:12px;color:var(--green)">‚úÖ Completed (18)</div>
  <div style="background:var(--surface);border-radius:12px;overflow:hidden;margin-bottom:20px">
    <div class="chk"><span class="ic">‚úÖ</span> Pause all TikTok campaigns (19/19)</div>
    <div class="chk"><span class="ic">‚úÖ</span> Install Judge.me reviews</div>
    <div class="chk"><span class="ic">‚úÖ</span> Free shipping announcement bar</div>
    <div class="chk"><span class="ic">‚úÖ</span> Deep-link Meta ads to collection pages</div>
    <div class="chk"><span class="ic">‚úÖ</span> Scale Meta budget to $15/day</div>
    <div class="chk"><span class="ic">‚úÖ</span> Reactivate Meta campaign</div>
    <div class="chk"><span class="ic">‚úÖ</span> CRO descriptions on 23/23 products</div>
    <div class="chk"><span class="ic">‚úÖ</span> SEO meta tags on 23/23 products</div>
    <div class="chk"><span class="ic">‚úÖ</span> 4 Tennis Pilsner products optimized</div>
    <div class="chk"><span class="ic">‚úÖ</span> Beer &amp; Tennis collection (12 products)</div>
    <div class="chk"><span class="ic">‚úÖ</span> Retro Gaming collection (3 products)</div>
    <div class="chk"><span class="ic">‚úÖ</span> Navigation expanded (8 items)</div>
    <div class="chk"><span class="ic">‚úÖ</span> Footer menu (10 items)</div>
    <div class="chk"><span class="ic">‚úÖ</span> About, FAQ, Size Guide, Shipping pages</div>
    <div class="chk"><span class="ic">‚úÖ</span> 6 SEO blog posts published</div>
    <div class="chk"><span class="ic">‚úÖ</span> AutoSEM Shopify router built</div>
    <div class="chk"><span class="ic">‚úÖ</span> Shopify token auto-refresh</div>
    <div class="chk"><span class="ic">‚úÖ</span> Shopify API authentication resolved</div>
  </div>

  <div style="font-size:15px;font-weight:600;margin-bottom:12px;color:var(--amber)">üîÑ In Progress (3)</div>
  <div style="background:var(--surface);border-radius:12px;overflow:hidden;margin-bottom:20px">
    <div class="chk"><span class="ic">üîÑ</span> <strong>Klaviyo email capture popup</strong> ‚Äî form config in Klaviyo dashboard</div>
    <div class="chk"><span class="ic">üîÑ</span> <strong>Abandoned cart flow</strong> ‚Äî 3-email Klaviyo sequence</div>
    <div class="chk"><span class="ic">üîÑ</span> <strong>Deploy AutoSEM v1.3.0</strong> ‚Äî Shopify router + deploy.py fix</div>
  </div>

  <div style="font-size:15px;font-weight:600;margin-bottom:12px;color:var(--dim)">üìã Backlog (2)</div>
  <div style="background:var(--surface);border-radius:12px;overflow:hidden;margin-bottom:20px">
    <div class="chk"><span class="ic">üìã</span> Add JSON-LD Product schema to theme</div>
    <div class="chk"><span class="ic">üìã</span> Optimize product URL handles</div>
  </div>
</div>

</div><!-- /wrap -->

<script>
const API = window.location.origin + '/api/v1';
let metaData = null;
let shopifyData = null;

// ‚îÄ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
  });
});

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
const fmt = (n, d=2) => typeof n === 'number' ? n.toFixed(d) : '‚Äî';
const fmtK = n => n >= 1000 ? (n/1000).toFixed(1) + 'K' : (n || 0).toString();

function showError(msg) {
  const el = $('errBanner');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 10000);
}

function updateTime() {
  $('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
}

// ‚îÄ‚îÄ‚îÄ Health Check ‚îÄ‚îÄ‚îÄ
async function loadHealth() {
  try {
    const resp = await fetch(API.replace('/api/v1','') + '/health');
    const data = await resp.json();
    $('healthStatus').textContent = data.status === 'healthy' ? 'Live' : 'Degraded';
    $('versionPill').textContent = 'v' + data.version;
  } catch(e) {
    $('healthStatus').textContent = 'Offline';
  }
}

// ‚îÄ‚îÄ‚îÄ Meta Performance ‚îÄ‚îÄ‚îÄ
async function loadMeta() {
  try {
    const resp = await fetch(API + '/dashboard/meta-performance');
    metaData = await resp.json();
    const s = metaData.summary || {};
    const campaigns = metaData.campaigns || [];

    // Calculate total revenue from campaigns
    let totalRevenue = 0;
    campaigns.forEach(c => { totalRevenue += (c.revenue || 0); });
    const totalSpend = s.total_spend || 0;
    const overallRoas = totalSpend > 0 ? totalRevenue / totalSpend : 0;

    // Overview cards
    $('ov-spend').textContent = '$' + fmt(totalSpend);
    $('ov-spend-note').textContent = campaigns.length + ' campaigns';
    $('ov-revenue').textContent = '$' + fmt(totalRevenue);
    $('ov-revenue').className = 'val ' + (totalRevenue > 0 ? 'g' : 'dim');
    $('ov-revenue-note').textContent = overallRoas > 0 ? fmt(overallRoas) + 'x ROAS' : 'From attributed orders';
    $('ov-clicks').textContent = fmtK(s.total_clicks);
    $('ov-clicks-note').textContent = '$' + fmt(s.avg_cpc) + ' per click';
    $('ov-cpc').textContent = '$' + fmt(s.avg_cpc);
    $('ov-cpc-note').textContent = s.avg_cpc < 0.15 ? 'Below $0.15 target' : 'Above target';

    // Meta tab cards
    $('m-spend').textContent = '$' + fmt(totalSpend);
    $('m-revenue').textContent = '$' + fmt(totalRevenue);
    $('m-revenue').className = 'val ' + (totalRevenue > 0 ? 'g' : '');
    $('m-revenue-note').textContent = totalRevenue > 0 ? (campaigns.filter(c=>c.revenue>0).length + ' attributed') : 'No revenue yet';
    $('m-roas').textContent = overallRoas > 0 ? fmt(overallRoas) + 'x' : '‚Äî';
    $('m-roas').className = 'val ' + (overallRoas >= 2 ? 'g' : overallRoas >= 1 ? 'a' : overallRoas > 0 ? 'r' : '');
    $('m-roas-note').textContent = overallRoas >= 2 ? 'Profitable' : overallRoas > 0 ? 'Below 2x target' : '';
    $('m-impressions').textContent = fmtK(s.total_impressions);
    $('m-clicks').textContent = s.total_clicks || 0;
    $('m-cpc').textContent = '$' + fmt(s.avg_cpc);

    // Campaign rows (with Revenue + ROAS columns)
    let html = '';
    campaigns.forEach(c => {
      const signal = c.cpc < 0.20 ? '<span class="g">‚òÖ Star performer</span>' :
                     c.cpc < 0.50 ? '<span class="a">‚óè Acceptable</span>' :
                     '<span class="r">‚ñº Review / pause</span>';
      const statusColor = c.status === 'ACTIVE' ? 'g' : 'r';
      const rev = c.revenue || 0;
      const roas = (c.spend && c.spend > 0 && rev) ? (rev / c.spend) : 0;
      const roasDisplay = roas > 0 ? fmt(roas) + 'x' : '<span style="color:var(--dim)">‚Äî</span>';
      const roasColor = roas >= 2 ? 'g' : roas >= 1 ? 'a' : roas > 0 ? 'r' : '';
      const revDisplay = rev > 0 ? '$' + fmt(rev) : '<span style="color:var(--dim)">$0.00</span>';
      const revColor = rev > 0 ? 'g' : '';
      html += `<tr>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.name}</td>
        <td class="mono ${statusColor}">${c.status}</td>
        <td class="mono">$${fmt(c.spend)}</td>
        <td class="mono ${revColor}">${revDisplay}</td>
        <td class="mono">${c.clicks}</td>
        <td class="mono ${c.ctr > 3 ? 'g' : c.ctr > 1 ? 'a' : 'r'}">${fmt(c.ctr)}%</td>
        <td class="mono ${c.cpc < 0.20 ? 'g' : c.cpc < 0.50 ? 'a' : 'r'}">$${fmt(c.cpc)}</td>
        <td class="mono ${roasColor}">${roasDisplay}</td>
        <td>${signal}</td>
      </tr>`;
    });
    $('metaRows').innerHTML = html || '<tr><td colspan="9" style="color:var(--dim)">No campaigns found</td></tr>';

    // Meta insight
    const best = campaigns.reduce((a,b) => (a.ctr||0) > (b.ctr||0) ? a : b, {});
    const worst = campaigns.reduce((a,b) => (a.cpc||0) > (b.cpc||0) ? a : b, {});
    if (campaigns.length > 1) {
      const ins = $('metaInsight');
      ins.style.display = 'block';
      ins.className = worst.cpc > 0.50 ? 'ins warn' : 'ins good';
      ins.innerHTML = `<strong>Best performer:</strong> "${best.name}" at ${fmt(best.ctr)}% CTR, $${fmt(best.cpc)} CPC.` +
        (worst.cpc > 0.50 ? ` <strong>Watch:</strong> "${worst.name}" has $${fmt(worst.cpc)} CPC ‚Äî consider pausing if it doesn't improve in 3 days.` : '');
    }

    // Progress bars
    $('prog-meta').style.width = '100%';
    $('prog-meta').textContent = '100% ‚Äî Active & optimized';

  } catch(e) {
    $('metaRows').innerHTML = '<tr><td colspan="9" style="color:var(--red)">Failed to load Meta data. Check API connection.</td></tr>';
  }
}

// ‚îÄ‚îÄ‚îÄ Shopify ‚îÄ‚îÄ‚îÄ
async function loadShopify() {
  try {
    // Try health check first
    const healthResp = await fetch(API + '/shopify/health-check');
    if (healthResp.ok) {
      const health = await healthResp.json();
      shopifyData = health;

      $('sh-status').textContent = health.token_valid ? '‚óè Live' : '‚óã Down';
      $('sh-status').className = 'val ' + (health.token_valid ? 'g' : 'r');
      $('sh-store').textContent = health.store || '';

      const p = health.products || {};
      $('sh-products').textContent = p.total || '‚Äî';
      $('sh-products-note').textContent = `CRO: ${p.cro_coverage || '‚Äî'} | ${p.price_range || ''}`;
      $('ov-products').textContent = p.total || '‚Äî';
      $('ov-products-note').textContent = `CRO: ${p.cro_coverage || '‚Äî'}`;

      const c = health.collections || {};
      const colTotal = (c.smart||0) + (c.custom||0);
      $('sh-collections').textContent = colTotal;
      $('sh-collections-note').textContent = `${c.smart||0} smart, ${c.custom||0} custom`;
      $('ov-collections').textContent = colTotal;
      $('ov-collections-note').textContent = `${c.smart||0} smart, ${c.custom||0} custom`;

      const hrs = Math.round((health.token_expires_in || 0) / 3600);
      $('sh-token').textContent = hrs + 'h';
      $('sh-token-note').textContent = hrs > 2 ? 'Auto-refresh enabled' : 'Refreshing soon...';
      $('ov-token').textContent = hrs + 'h';
      $('ov-token').className = 'val ' + (hrs > 4 ? 'g' : hrs > 1 ? 'a' : 'r');
      $('ov-token-note').textContent = 'Token TTL';

      // Products
      $('seo-cro').textContent = p.cro_coverage || '‚Äî';
      $('seo-meta').textContent = (p.total||0) + '/' + (p.total||0);

      $('prog-products').style.width = '100%';
      $('prog-products').textContent = '100% ‚Äî ' + (p.cro_coverage||'') + ' products';
      $('prog-overall').style.width = '78%';
      $('prog-overall').textContent = '78% ‚Äî 18/23 items';
      $('prog-email').style.width = '33%';
      $('prog-email').textContent = '33% ‚Äî Forms pending';
      $('prog-tech').style.width = '80%';
      $('prog-tech').textContent = '80% ‚Äî JSON-LD pending';

      // Load product list
      loadProducts();
      loadBlogs();
    } else {
      // Shopify router not deployed yet ‚Äî show status
      $('sh-status').textContent = 'Pending';
      $('sh-status').className = 'val a';
      $('sh-store').textContent = 'Router deploying...';
      $('shopifyRows').innerHTML = '<tr><td colspan="4" style="color:var(--dim)">Shopify router not yet deployed.</td></tr>';

      // Try loading product count from campaigns/products API
      try {
        const prodResp = await fetch(API + '/products/');
        if (prodResp.ok) {
          const prods = await prodResp.json();
          const total = Array.isArray(prods) ? prods.length : 0;
          $('ov-products').textContent = total;
          $('ov-products-note').textContent = `From local DB`;
          $('seo-cro').textContent = total + ' products';
        } else {
          $('ov-products').textContent = '‚Äî';
          $('ov-products-note').textContent = 'API unavailable';
        }
      } catch(pe) {
        $('ov-products').textContent = '‚Äî';
      }
    }
  } catch(e) {
    $('shopifyRows').innerHTML = '<tr><td colspan="4" style="color:var(--dim)">Shopify router not available.</td></tr>';
    $('ov-products').textContent = '‚Äî';
    $('ov-products-note').textContent = 'Shopify offline';
  }
}

async function loadProducts() {
  try {
    const resp = await fetch(API + '/shopify/products');
    const data = await resp.json();
    const products = data.products || [];
    let html = '';
    products.forEach(p => {
      const descOk = p.has_description;
      html += `<tr>
        <td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.title}</td>
        <td class="mono">$${p.price}</td>
        <td class="${descOk?'g':'r'}">${descOk ? p.description_length + ' chars ‚úì' : '‚úó Missing'}</td>
        <td class="g">‚úì</td>
      </tr>`;
    });
    $('shopifyRows').innerHTML = html || '<tr><td colspan="4">No products</td></tr>';
  } catch(e) {}
}

async function loadBlogs() {
  try {
    const resp = await fetch(API + '/shopify/blog-posts');
    const data = await resp.json();
    const posts = data.posts || [];
    $('ov-blogs').textContent = posts.length;
    $('seo-blogs').textContent = posts.length;
    let html = '';
    posts.forEach(p => {
      const date = p.published_at ? new Date(p.published_at).toLocaleDateString() : 'Draft';
      html += `<tr>
        <td>${p.title}</td>
        <td class="mono">${date}</td>
        <td style="color:var(--dim)">${p.tags || '‚Äî'}</td>
      </tr>`;
    });
    $('blogRows').innerHTML = html || '<tr><td colspan="3">No posts</td></tr>';
  } catch(e) {
    $('ov-blogs').textContent = '6';
    $('seo-blogs').textContent = '6';
    $('blogRows').innerHTML = '<tr><td colspan="3" style="color:var(--dim)">Blog API not available yet</td></tr>';
  }
}

// ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ
async function syncMeta() {
  try {
    await fetch(API + '/dashboard/sync-meta', { method: 'POST' });
    loadMeta();
  } catch(e) { showError('Sync failed: ' + e.message); }
}

async function refreshToken() {
  try {
    const resp = await fetch(API + '/shopify/refresh-token', { method: 'POST' });
    const data = await resp.json();
    if (data.status === 'refreshed') {
      loadShopify();
    } else {
      showError('Token refresh failed: ' + (data.message || ''));
    }
  } catch(e) { showError('Token refresh failed: ' + e.message); }
}

// ‚îÄ‚îÄ‚îÄ Meta Campaign Controls ‚îÄ‚îÄ‚îÄ
async function metaCampaignAction(action) {
  const id = $('metaCampaignId').value.trim();
  if (!id) { $('metaActionResult').textContent = 'Enter a campaign ID'; return; }
  try {
    const resp = await fetch(API + '/meta/' + action + '-campaign', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({campaign_id: id})
    });
    const data = await resp.json();
    $('metaActionResult').textContent = data.status === action.replace('activate','activated').replace('pause','paused') ? action + 'd successfully' : (data.message || 'Failed');
    $('metaActionResult').style.color = data.status === 'error' ? 'var(--red)' : 'var(--green)';
    loadMeta();
  } catch(e) { $('metaActionResult').textContent = 'Error: ' + e.message; $('metaActionResult').style.color = 'var(--red)'; }
}

async function metaSetBudget() {
  const id = $('metaCampaignId').value.trim();
  const budget = parseInt($('metaBudget').value);
  if (!id || !budget) { $('metaActionResult').textContent = 'Enter campaign ID and budget'; return; }
  try {
    const resp = await fetch(API + '/meta/set-budget', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({campaign_id: id, daily_budget_cents: budget * 100})
    });
    const data = await resp.json();
    $('metaActionResult').textContent = data.status === 'updated' ? 'Budget set to $' + budget + '/day' : (data.message || 'Failed');
    $('metaActionResult').style.color = data.status === 'error' ? 'var(--red)' : 'var(--green)';
  } catch(e) { $('metaActionResult').textContent = 'Error: ' + e.message; $('metaActionResult').style.color = 'var(--red)'; }
}

// ‚îÄ‚îÄ‚îÄ Klaviyo ‚îÄ‚îÄ‚îÄ
async function loadKlaviyo() {
  try {
    const statusResp = await fetch(API + '/klaviyo/status');
    const status = await statusResp.json();
    if (status.connected) {
      $('kl-status').textContent = 'Connected';
      $('kl-status').className = 'val g';
      $('kl-status-note').textContent = status.account_name || '';
    } else {
      $('kl-status').textContent = status.status === 'not_configured' ? 'Not Set' : 'Error';
      $('kl-status').className = 'val ' + (status.status === 'not_configured' ? 'a' : 'r');
      $('kl-status-note').textContent = status.message || '';
      $('klaviyoFlowRows').innerHTML = '<tr><td colspan="4" style="color:var(--dim)">' + (status.message || 'Klaviyo not configured') + '</td></tr>';
      return;
    }

    // Load flows
    const flowsResp = await fetch(API + '/klaviyo/flows');
    const flowsData = await flowsResp.json();
    const flows = flowsData.flows || [];
    $('kl-flows').textContent = flows.length;
    let html = '';
    flows.forEach(f => {
      const statusColor = f.status === 'live' ? 'g' : f.status === 'draft' ? 'a' : 'r';
      html += '<tr><td>' + (f.name||'‚Äî') + '</td><td class="mono ' + statusColor + '">' + (f.status||'‚Äî') + '</td><td>' + (f.trigger_type||'‚Äî') + '</td><td class="mono">' + (f.updated ? new Date(f.updated).toLocaleDateString() : '‚Äî') + '</td></tr>';
    });
    $('klaviyoFlowRows').innerHTML = html || '<tr><td colspan="4" style="color:var(--dim)">No flows found. Create an abandoned cart flow to get started.</td></tr>';

    // Load metrics
    const metricsResp = await fetch(API + '/klaviyo/metrics');
    const metricsData = await metricsResp.json();
    $('kl-metrics').textContent = metricsData.flow_count || metricsData.count || 0;

    // Load profiles count
    const profilesResp = await fetch(API + '/klaviyo/profiles?page_size=1');
    const profilesData = await profilesResp.json();
    $('kl-profiles').textContent = profilesData.count || 0;

  } catch(e) {
    $('kl-status').textContent = 'Offline';
    $('kl-status').className = 'val r';
    $('klaviyoFlowRows').innerHTML = '<tr><td colspan="4" style="color:var(--dim)">Could not reach Klaviyo API</td></tr>';
  }
}

async function createAbandonedCartFlow() {
  const result = $('klaviyoFlowResult');
  result.style.display = 'block';
  result.className = 'ins';
  result.textContent = 'Creating abandoned cart flow...';
  try {
    const resp = await fetch(API + '/klaviyo/create-abandoned-cart-flow', { method: 'POST' });
    const data = await resp.json();
    if (data.status === 'created') {
      result.className = 'ins good';
      result.innerHTML = '<strong>Flow created!</strong> ' + (data.emails_created||0) + ' emails, discount code: ' + (data.discount_code||'none') + '. Review templates in Klaviyo UI.';
      loadKlaviyo();
    } else {
      result.className = 'ins crit';
      result.textContent = 'Failed: ' + (data.message || 'Unknown error');
    }
  } catch(e) {
    result.className = 'ins crit';
    result.textContent = 'Error: ' + e.message;
  }
}

// ‚îÄ‚îÄ‚îÄ System Health ‚îÄ‚îÄ‚îÄ
async function loadDeepHealth() {
  try {
    const resp = await fetch(API + '/health/deep');
    const data = await resp.json();
    const c = data.checks || {};

    $('h-overall').textContent = data.status === 'healthy' ? 'Healthy' : 'Degraded';
    $('h-overall').className = 'val ' + (data.status === 'healthy' ? 'g' : 'a');
    $('h-issues').textContent = (data.issues || []).length;
    $('h-issues').className = 'val ' + ((data.issues||[]).length === 0 ? 'g' : 'a');

    // DB
    const db = c.database || {};
    $('h-db').textContent = db.status === 'ok' ? 'OK' : 'Error';
    $('h-db').className = 'val ' + (db.status === 'ok' ? 'g' : 'r');
    $('hc-db').textContent = db.status === 'ok' ? '‚úÖ' : '‚ùå';
    $('hc-db-text').textContent = 'Database ‚Äî ' + (db.engine || db.message || 'unknown');

    // Scheduler
    const sched = c.scheduler || {};
    $('h-scheduler').textContent = sched.running ? 'Running' : 'Stopped';
    $('h-scheduler').className = 'val ' + (sched.running ? 'g' : 'r');
    $('hc-sched').textContent = sched.running ? '‚úÖ' : '‚ùå';
    $('hc-sched-text').textContent = 'Scheduler ‚Äî ' + (sched.running ? sched.jobs + ' jobs' : (sched.message || 'stopped'));

    // Meta
    const meta = c.meta_token || {};
    $('hc-meta').textContent = meta.present ? '‚úÖ' : '‚ö†Ô∏è';
    $('hc-meta-text').textContent = 'Meta Token ‚Äî ' + (meta.present ? (meta.days_remaining != null ? meta.days_remaining + ' days left' : 'present') : 'not configured');

    // TikTok
    const tt = c.tiktok_token || {};
    $('hc-tiktok').textContent = tt.present ? '‚úÖ' : '‚ö†Ô∏è';
    $('hc-tiktok-text').textContent = 'TikTok Token ‚Äî ' + (tt.present ? 'configured' : 'not configured');

    // Shopify
    const sh = c.shopify_token || {};
    $('hc-shopify').textContent = sh.status === 'ok' ? '‚úÖ' : '‚ö†Ô∏è';
    $('hc-shopify-text').textContent = 'Shopify Token ‚Äî ' + (sh.status === 'ok' ? sh.ttl_hours + 'h remaining' : (sh.message || 'expired'));

    // Klaviyo
    const kl = c.klaviyo || {};
    $('hc-klaviyo').textContent = kl.configured ? '‚úÖ' : '‚ö†Ô∏è';
    $('hc-klaviyo-text').textContent = 'Klaviyo ‚Äî ' + (kl.configured ? 'configured' : 'not configured');

    // Last optimization
    const opt = c.last_optimization || {};
    $('hc-opt').textContent = opt.timestamp ? '‚úÖ' : '‚ö†Ô∏è';
    $('hc-opt-text').textContent = 'Last Optimization ‚Äî ' + (opt.timestamp ? new Date(opt.timestamp).toLocaleString() : 'never run');

    // Campaigns
    const camps = c.campaigns || {};
    $('h-campaigns').textContent = camps.total || 0;
    $('h-campaigns-note').textContent = (camps.active||0) + ' active, ' + (camps.paused||0) + ' paused, ' + (camps.draft||0) + ' draft';

    // Financials
    const fin = c.financials || {};
    $('h-spend').textContent = '$' + fmt(fin.total_spend || 0);
    $('h-revenue').textContent = '$' + fmt(fin.total_revenue || 0);
    $('h-roas').textContent = fmt(fin.overall_roas || 0) + 'x';

  } catch(e) {
    $('h-overall').textContent = 'Error';
    $('h-overall').className = 'val r';
  }
}

// ‚îÄ‚îÄ‚îÄ Automation Status (Last Sync) ‚îÄ‚îÄ‚îÄ
async function loadAutomationStatus() {
  try {
    const resp = await fetch(API + '/automation/status');
    const data = await resp.json();
    const lastSync = data.last_sync_performance || data.last_optimization;
    if (lastSync) {
      $('lastSync').textContent = 'Last sync: ' + new Date(lastSync).toLocaleString();
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ Activity Log ‚îÄ‚îÄ‚îÄ
async function loadActivityLog() {
  try {
    const resp = await fetch(API + '/automation/activity-log?limit=20');
    const data = await resp.json();
    const logs = data.logs || [];
    let html = '';
    logs.forEach(l => {
      const ts = l.timestamp ? new Date(l.timestamp).toLocaleString() : '‚Äî';
      const actionColor = l.action === 'AUTO_OPTIMIZE' ? 'b' : l.action.startsWith('EMERGENCY') ? 'r' : '';
      html += `<tr>
        <td class="mono" style="white-space:nowrap;font-size:12px">${ts}</td>
        <td class="mono ${actionColor}" style="font-size:12px">${l.action}</td>
        <td style="font-size:12px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${l.details || '‚Äî'}</td>
      </tr>`;
    });
    $('activityLogRows').innerHTML = html || '<tr><td colspan="3" style="color:var(--dim)">No activity logged yet</td></tr>';
  } catch(e) {
    $('activityLogRows').innerHTML = '<tr><td colspan="3" style="color:var(--dim)">Could not load activity log</td></tr>';
  }
}

// ‚îÄ‚îÄ‚îÄ Shopify Scopes ‚îÄ‚îÄ‚îÄ
async function loadShopifyScopes() {
  try {
    const resp = await fetch(API + '/shopify/status');
    if (!resp.ok) { $('shopifyScopesBox').innerHTML = '<span style="color:var(--dim)">Shopify offline</span>'; return; }
    const data = await resp.json();
    const scopes = data.scopes || '';
    if (!scopes) { $('shopifyScopesBox').innerHTML = '<span style="color:var(--dim)">No scopes data</span>'; return; }

    const scopeList = scopes.split(',').map(s => s.trim());
    const hasOrders = scopeList.some(s => s.includes('order'));
    let html = '<div style="font-size:12px;display:flex;flex-wrap:wrap;gap:6px">';
    scopeList.forEach(s => {
      const isOrder = s.includes('order');
      html += `<span style="padding:3px 8px;border-radius:6px;background:${isOrder ? 'var(--green-bg)' : 'var(--surface2)'};color:${isOrder ? 'var(--green)' : 'var(--dim)'};font-family:'IBM Plex Mono';font-size:11px">${s}</span>`;
    });
    html += '</div>';
    if (!hasOrders) {
      html += '<div style="margin-top:10px;padding:8px 12px;background:var(--amber-bg);border-radius:8px;font-size:12px;color:var(--amber)">‚ö† Missing orders scope ‚Äî webhook will not receive order data. Check Shopify app permissions.</div>';
    }
    $('shopifyScopesBox').innerHTML = html;
  } catch(e) {
    $('shopifyScopesBox').innerHTML = '<span style="color:var(--dim)">Could not load scopes</span>';
  }
}

// ‚îÄ‚îÄ‚îÄ JSON-LD Generator ‚îÄ‚îÄ‚îÄ
async function generateAllJsonLd() {
  const result = $('jsonldResult');
  const status = $('jsonldStatus');
  result.textContent = 'Generating...';
  result.style.color = 'var(--dim)';
  try {
    const resp = await fetch(API + '/seo/all-jsonld');
    const data = await resp.json();
    if (data.status === 'ok') {
      result.textContent = data.count + ' products generated';
      result.style.color = 'var(--green)';
      let html = '<table class="tbl" style="margin-top:12px"><thead><tr><th>Product</th><th>Price</th><th>Availability</th></tr></thead><tbody>';
      (data.products || []).forEach(p => {
        const price = p.offers ? (p.offers.price || p.offers.lowPrice || '‚Äî') : '‚Äî';
        const avail = (p.offers && p.offers.availability) ? (p.offers.availability.includes('InStock') ? '<span class="g">In Stock</span>' : '<span class="r">Out of Stock</span>') : '‚Äî';
        html += '<tr><td>' + (p.name||'‚Äî') + '</td><td class="mono">$' + price + '</td><td>' + avail + '</td></tr>';
      });
      html += '</tbody></table>';
      status.innerHTML = html;
    } else {
      result.textContent = data.message || 'Failed';
      result.style.color = 'var(--red)';
    }
  } catch(e) {
    result.textContent = 'Error: ' + e.message;
    result.style.color = 'var(--red)';
  }
}

// ‚îÄ‚îÄ‚îÄ Optimizer Actions ‚îÄ‚îÄ‚îÄ
async function loadOptimizerActions() {
  try {
    const resp = await fetch(API + '/automation/activity-log?limit=50');
    const data = await resp.json();
    const logs = (data.logs || []).filter(l =>
      l.action === 'AUTO_OPTIMIZE' || l.action === 'MANUAL_OPTIMIZE' ||
      l.action === 'SCHEDULER_OPTIMIZE' || l.action === 'PERFORMANCE_SYNC'
    ).slice(0, 10);
    let html = '';
    logs.forEach(l => {
      const ts = l.timestamp ? new Date(l.timestamp).toLocaleString() : '‚Äî';
      const actionColor = l.action === 'AUTO_OPTIMIZE' ? 'b' : l.action === 'MANUAL_OPTIMIZE' ? 'g' : '';
      const campId = l.entity_id || '‚Äî';
      html += `<tr>
        <td class="mono" style="white-space:nowrap;font-size:12px">${ts}</td>
        <td class="mono ${actionColor}" style="font-size:12px">${l.action}</td>
        <td class="mono" style="font-size:12px">${campId}</td>
        <td style="font-size:12px;max-width:350px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${l.details || '‚Äî'}</td>
      </tr>`;
    });
    $('optimizerRows').innerHTML = html || '<tr><td colspan="4" style="color:var(--dim)">No optimizer actions yet. Click "Optimize Now" to trigger.</td></tr>';
  } catch(e) {
    $('optimizerRows').innerHTML = '<tr><td colspan="4" style="color:var(--dim)">Could not load optimizer log</td></tr>';
  }
}

async function runOptimizeNow() {
  const status = $('optimizerStatus');
  status.textContent = 'Running optimizer...';
  status.style.color = 'var(--blue)';
  try {
    const resp = await fetch(API + '/dashboard/optimize-now', { method: 'POST' });
    const data = await resp.json();
    if (data.status === 'ok') {
      const actionCount = (data.actions || []).length;
      status.textContent = 'Done: ' + data.optimized + ' campaigns, ' + actionCount + ' actions';
      status.style.color = 'var(--green)';
      loadOptimizerActions();
      loadMeta();
    } else {
      status.textContent = 'Error: ' + (data.message || 'unknown');
      status.style.color = 'var(--red)';
    }
  } catch(e) {
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--red)';
  }
}

async function runSyncPerformance() {
  const status = $('optimizerStatus');
  status.textContent = 'Syncing performance data...';
  status.style.color = 'var(--blue)';
  try {
    const resp = await fetch(API + '/dashboard/sync-performance', { method: 'POST' });
    const data = await resp.json();
    if (data.status === 'ok') {
      const meta = data.results?.meta || {};
      status.textContent = 'Synced: ' + (meta.campaigns_synced || 0) + ' campaigns from Meta';
      status.style.color = 'var(--green)';
      loadMeta();
      loadOptimizerActions();
    } else {
      status.textContent = 'Error: ' + (data.message || 'unknown');
      status.style.color = 'var(--red)';
    }
  } catch(e) {
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--red)';
  }
}

// ‚îÄ‚îÄ‚îÄ Funnel ‚îÄ‚îÄ‚îÄ
async function loadFunnel() {
  try {
    const resp = await fetch(API + '/dashboard/funnel');
    const data = await resp.json();
    if (data.status !== 'ok') return;
    const f = data.funnel || {};
    $('funnelLoading').style.display = 'none';
    $('funnelContent').style.display = 'block';
    $('fn-impressions').textContent = fmtK(f.impressions);
    $('fn-clicks').textContent = f.clicks || 0;
    $('fn-ctr').textContent = f.ctr + '% CTR';
    $('fn-lpv').textContent = f.landing_page_views || 0;
    $('fn-lpv-rate').textContent = (data.dropoff||{}).click_to_landing_page + '% of clicks';
    $('fn-purchases').textContent = f.purchases || 0;
    $('fn-purchases').className = f.purchases > 0 ? 'g' : 'r';
    $('fn-purchases').style.fontFamily = "'IBM Plex Mono'";
    $('fn-purchases').style.fontSize = '22px';
    $('fn-purchases').style.fontWeight = '700';
    $('fn-purchases').style.color = f.purchases > 0 ? 'var(--green)' : 'var(--red)';
    $('fn-conv-rate').textContent = (data.dropoff||{}).click_to_purchase + '% conv';
    $('fn-revenue').textContent = '$' + fmt(f.revenue);
    $('fn-revenue').style.color = f.revenue > 0 ? 'var(--green)' : 'var(--red)';

    // Warnings
    const warnings = data.warnings || [];
    if (warnings.length > 0) {
      const w = warnings[0];
      $('funnelWarning').style.display = 'block';
      $('funnelWarningMsg').textContent = w.message;
      let clHtml = '';
      (w.checklist || []).forEach(item => { clHtml += '<li>' + item + '</li>'; });
      $('funnelChecklist').innerHTML = clHtml;
    }
  } catch(e) {
    $('funnelLoading').textContent = 'Funnel data unavailable';
  }
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
async function refreshAll() {
  await Promise.all([loadHealth(), loadMeta(), loadShopify(), loadKlaviyo(), loadDeepHealth(), loadAutomationStatus(), loadActivityLog(), loadShopifyScopes(), loadOptimizerActions(), loadFunnel()]);
  updateTime();
}

refreshAll();
setInterval(refreshAll, 60000); // Full refresh every 60s
setInterval(loadActivityLog, 30000); // Activity log every 30s
</script>
</body>
</html>
